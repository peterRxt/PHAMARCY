<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root { --primary-color: #3498db; --secondary-color: #2ecc71; --danger-color: #e74c3c; --warning-color: #f39c12; --dark-color: #2c3e50; --light-color: #ecf0f1; --gray-color: #95a5a6; --pharmacy-blue: #2980b9; --pharmacy-green: #27ae60; --pharmacy-purple: #8e44ad; --shadow: 0 8px 24px rgba(0, 0, 0, 0.12); --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05); --gradient-primary: linear-gradient(135deg, #3498db, #2980b9); --gradient-success: linear-gradient(135deg, #2ecc71, #27ae60); --gradient-warning: linear-gradient(135deg, #f39c12, #e67e22); --gradient-danger: linear-gradient(135deg, #e74c3c, #c0392b); --border-radius: 16px; --border-radius-sm: 8px; --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        body { background-color: #f8fafc; color: #333; line-height: 1.6; overflow-x: hidden; }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--pharmacy-blue), #1a5276); color: white; padding: 24px 32px; border-radius: var(--border-radius); margin-bottom: 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--pharmacy-green), var(--pharmacy-purple)); }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo i { font-size: 2.8rem; background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px); }
        .logo h1 { font-size: 1.9rem; font-weight: 700; letter-spacing: -0.5px; }
        .logo p { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; }
        .controls { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .branch-selector { display: flex; gap: 10px; align-items: center; background: rgba(255, 255, 255, 0.1); padding: 8px; border-radius: var(--border-radius-sm); backdrop-filter: blur(10px); }
        .branch-btn { padding: 10px 20px; background: transparent; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 500; transition: var(--transition); position: relative; overflow: hidden; }
        .branch-btn::after { content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 2px; background: white; transition: var(--transition); transform: translateX(-50%); }
        .branch-btn:hover::after { width: 70%; }
        .branch-btn.active { background: white; color: var(--pharmacy-blue); box-shadow: var(--shadow-light); }
        .file-upload { position: relative; overflow: hidden; display: inline-block; }
        .file-upload-btn { padding: 12px 24px; background: var(--gradient-success); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition); box-shadow: var(--shadow-light); }
        .file-upload-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(46, 204, 113, 0.3); }
        .file-upload input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .date-range { display: flex; gap: 12px; align-items: center; background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: var(--border-radius-sm); backdrop-filter: blur(10px); }
        .date-input { padding: 10px 14px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: var(--border-radius-sm); background: rgba(255, 255, 255, 0.1); color: white; font-weight: 500; }
        .date-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .date-display { color: white; font-size: 0.9rem; font-weight: 500; padding: 8px 16px; background: rgba(255, 255, 255, 0.1); border-radius: var(--border-radius-sm); display: none; align-items: center; gap: 8px; }
        .date-display.active { display: flex; }
        .apply-btn { padding: 10px 20px; background: rgba(255, 255, 255, 0.2); border: none; border-radius: var(--border-radius-sm); color: white; cursor: pointer; font-weight: 600; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
        .apply-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 40px; }
        .card { background: white; border-radius: var(--border-radius); padding: 24px; box-shadow: var(--shadow-light); transition: var(--transition); position: relative; overflow: hidden; border: 1px solid rgba(0, 0, 0, 0.05); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .card.sales::before { background: var(--gradient-primary); }
        .card.clients::before { background: var(--gradient-success); }
        .card.basket::before { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .card.products::before { background: var(--gradient-warning); }
        .card:hover { transform: translateY(-8px); box-shadow: var(--shadow); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .card-icon { width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; background: rgba(52, 152, 219, 0.1); color: var(--primary-color); }
        .clients .card-icon { background: rgba(46, 204, 113, 0.1); color: var(--secondary-color); }
        .basket .card-icon { background: rgba(155, 89, 182, 0.1); color: #9b59b6; }
        .products .card-icon { background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
        .card-content { display: flex; flex-direction: column; gap: 8px; }
        .card-value { font-size: 2.4rem; font-weight: 700; margin-bottom: 4px; }
        .card-label { color: var(--gray-color); font-size: 0.95rem; font-weight: 500; }
        .card-change { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 4px; margin-top: 4px; }
        .card-change.positive { color: var(--secondary-color); }
        .card-change.negative { color: var(--danger-color); }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 40px; }
        .reports-section { background: white; border-radius: var(--border-radius); padding: 28px; box-shadow: var(--shadow-light); border: 1px solid rgba(0, 0, 0, 0.05); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f1f5f9; }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--dark-color); display: flex; align-items: center; gap: 12px; }
        .section-title i { color: var(--primary-color); font-size: 1.3rem; }
        .export-btn { padding: 10px 20px; background: var(--gradient-primary); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition); box-shadow: var(--shadow-light); }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(52, 152, 219, 0.3); }
        .tabs { display: flex; border-bottom: 2px solid #f1f5f9; margin-bottom: 24px; gap: 4px; flex-wrap: wrap; }
        .tab { padding: 14px 24px; cursor: pointer; font-weight: 600; color: var(--gray-color); border-bottom: 3px solid transparent; transition: var(--transition); position: relative; border-radius: 6px 6px 0 0; white-space: nowrap; }
        .tab:hover { color: var(--primary-color); background: rgba(52, 152, 219, 0.05); }
        .tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: rgba(52, 152, 219, 0.08); }
        .tab-badge { position: absolute; top: 8px; right: 8px; background: var(--danger-color); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-content.active { display: block; }
        .chart-container { height: 320px; margin-bottom: 24px; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: var(--border-radius-sm); overflow: hidden; box-shadow: var(--shadow-light); }
        thead { background: linear-gradient(135deg, #f8fafc, #e2e8f0); }
        th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { font-weight: 700; color: var(--dark-color); text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        tr { transition: var(--transition); }
        tr:hover { background-color: #f8fafc; transform: translateX(4px); }
        .product-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-right: 8px; }
        .badge-fast { background: rgba(46, 204, 113, 0.1); color: var(--secondary-color); }
        .badge-slow { background: rgba(231, 76, 60, 0.1); color: var(--danger-color); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--gray-color); }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; color: #e2e8f0; opacity: 0.5; }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 10px; color: #64748b; }
        .empty-state p { font-size: 1rem; max-width: 400px; margin: 0 auto; }
        footer { text-align: center; padding: 24px; color: var(--gray-color); font-size: 0.9rem; border-top: 1px solid #e2e8f0; margin-top: 40px; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-light); }
        .loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .loader.active { display: flex; }
        .spinner { width: 70px; height: 70px; border: 5px solid #f1f5f9; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .loader-text { font-size: 1.2rem; font-weight: 600; color: var(--dark-color); margin-top: 15px; }
        .loader-progress { width: 300px; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .loader-progress-bar { height: 100%; background: var(--gradient-primary); width: 0%; transition: width 0.3s ease; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; top: 30px; right: 30px; padding: 16px 24px; background: white; border-radius: var(--border-radius-sm); box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; transform: translateX(400px); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 1000; border-left: 4px solid var(--secondary-color); max-width: 400px; }
        .notification.show { transform: translateX(0); }
        .notification i { font-size: 1.5rem; color: var(--secondary-color); }
        .notification-content h4 { font-size: 1rem; margin-bottom: 4px; color: var(--dark-color); }
        .notification-content p { font-size: 0.9rem; color: var(--gray-color); }
        .growth-rate { font-size: 0.9rem; padding: 20px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: var(--border-radius-sm); margin-top: 20px; }
        .growth-rate h4 { margin-bottom: 16px; color: var(--dark-color); font-size: 1.1rem; }
        .growth-table { width: 100%; border-collapse: collapse; }
        .growth-table td { padding: 10px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        .growth-table tr:last-child td { border-bottom: none; }
        .growth-table td:first-child { font-weight: 500; color: var(--dark-color); }
        .growth-table td:last-child { text-align: right; font-weight: 600; }
        .growth-value.positive { color: var(--secondary-color); }
        .growth-value.negative { color: var(--danger-color); }
        .filter-controls { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; padding: 15px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: var(--border-radius-sm); flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-label { font-weight: 600; color: var(--dark-color); font-size: 0.9rem; }
        .filter-input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: var(--border-radius-sm); width: 80px; font-weight: 500; transition: var(--transition); }
        .filter-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .filter-btn { padding: 8px 16px; background: var(--gradient-primary); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition); }
        .filter-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2); }
        .filter-reset-btn { padding: 8px 16px; background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition); }
        .filter-reset-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(149, 165, 166, 0.2); }
        .stats-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: var(--border-radius-sm); }
        .stat-item { text-align: center; padding: 12px; }
        .stat-value { font-size: 1.3rem; font-weight: 700; color: var(--dark-color); margin-bottom: 4px; }
        .stat-label { font-size: 0.85rem; color: var(--gray-color); font-weight: 500; }
        .branch-filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; padding: 10px; background: #f1f5f9; border-radius: var(--border-radius-sm); }
        .branch-filter-tab { padding: 8px 16px; background: transparent; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: var(--transition); }
        .branch-filter-tab.active { background: var(--primary-color); color: white; }
        .customer-stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .customer-stat-card { flex: 1; background: white; padding: 20px; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-light); text-align: center; border-left: 4px solid var(--primary-color); }
        .customer-stat-card.registered { border-left-color: var(--secondary-color); }
        .customer-stat-card.walkin { border-left-color: var(--warning-color); }
        .customer-stat-value { font-size: 2rem; font-weight: 700; }
        .customer-stat-label { color: var(--gray-color); font-size: 0.9rem; }
        .target-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .target-table th { background: var(--primary-color); color: white; padding: 12px; text-align: center; }
        .target-table td { padding: 10px; border-bottom: 1px solid #ddd; text-align: right; }
        .target-table td:first-child { text-align: left; font-weight: 600; }
        .target-table .achieved { color: var(--secondary-color); font-weight: 600; }
        .target-table .missed { color: var(--danger-color); font-weight: 600; }
        .target-table .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .status-complete { background: #d4edda; color: #155724; }
        .status-incomplete { background: #fff3cd; color: #856404; }
        @media (max-width: 1400px) { .dashboard { grid-template-columns: repeat(2, 1fr); } .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 1200px) { .filter-controls { flex-wrap: wrap; } }
        @media (max-width: 992px) { header { flex-direction: column; gap: 20px; align-items: stretch; } .controls { flex-direction: column; align-items: stretch; } .branch-selector { justify-content: center; flex-wrap: wrap; } .date-range { flex-wrap: wrap; } }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } .tabs { flex-wrap: wrap; } .tab { flex: 1; min-width: 120px; text-align: center; } .filter-controls { flex-direction: column; align-items: stretch; } .filter-group { width: 100%; justify-content: space-between; } }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loaderText">Processing your data...</div>
        <div class="loader-progress"><div class="loader-progress-bar" id="loaderProgress"></div></div>
    </div>
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div class="notification-content">
            <h4 id="notificationTitle">Success</h4>
            <p id="notificationMessage">Data loaded successfully</p>
        </div>
    </div>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-pills"></i>
                <div><h1>Pharmacy Dashboard</h1></div>
            </div>
            <div class="controls">
                <div class="date-display" id="dateDisplay"><i class="fas fa-calendar-alt"></i><span id="dateRangeText">No data loaded</span></div>
                <div class="branch-selector">
                    <button class="branch-btn active" data-branch="all">All Branches</button>
                    <button class="branch-btn" data-branch="Pharmacy POS">Syokimau Branch</button>
                    <button class="branch-btn" data-branch="Katani Pharmacy">Katani Branch</button>
                </div>
                <div class="file-upload">
                    <button class="file-upload-btn"><i class="fas fa-file-upload"></i> Upload Excel File</button>
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                </div>
                <div class="date-range">
                    <input type="date" id="startDate" class="date-input"> <span style="color: white;">to</span>
                    <input type="date" id="endDate" class="date-input">
                    <button id="applyDate" class="apply-btn"><i class="fas fa-filter"></i> Apply Filter</button>
                </div>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="card sales">
                <div class="card-header">
                    <div class="card-content">
                        <div class="card-value" id="totalSales">KSh 0</div>
                        <div class="card-label">Total Sales</div>
                        <div class="card-change positive" id="salesChange"><i class="fas fa-arrow-up"></i> 0%</div>
                    </div>
                    <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                </div>
            </div>
            <div class="card clients">
                <div class="card-header">
                    <div class="card-content">
                        <div class="card-value" id="clientsCount">0</div>
                        <div class="card-label">Total Customers</div>
                        <div class="card-change positive" id="clientsChange"><i class="fas fa-arrow-up"></i> 0%</div>
                    </div>
                    <div class="card-icon"><i class="fas fa-users"></i></div>
                </div>
            </div>
            <div class="card basket">
                <div class="card-header">
                    <div class="card-content">
                        <div class="card-value" id="basketValue">KSh 0</div>
                        <div class="card-label">Avg Basket Value</div>
                        <div class="card-change positive" id="basketChange"><i class="fas fa-arrow-up"></i> 0%</div>
                    </div>
                    <div class="card-icon"><i class="fas fa-shopping-basket"></i></div>
                </div>
            </div>
            <div class="card products">
                <div class="card-header">
                    <div class="card-content">
                        <div class="card-value" id="productsCount">0</div>
                        <div class="card-label">Products Sold</div>
                        <div class="card-change positive" id="productsChange"><i class="fas fa-arrow-up"></i> 0%</div>
                    </div>
                    <div class="card-icon"><i class="fas fa-capsules"></i></div>
                </div>
            </div>
        </div>
        
        <!-- Customer Type Stats -->
        <div class="customer-stats">
            <div class="customer-stat-card registered">
                <div class="customer-stat-value" id="registeredCount">0</div>
                <div class="customer-stat-label">Registered Customers</div>
            </div>
            <div class="customer-stat-card walkin">
                <div class="customer-stat-value" id="walkinCount">0</div>
                <div class="customer-stat-label">Walk-in Customers</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="reports-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Analytics Reports</h2>
                    <button class="export-btn" id="exportReport"><i class="fas fa-file-export"></i> Export Full Report</button>
                </div>
                
                <div class="filter-controls">
                    <div class="filter-group">
                        <span class="filter-label">Fast Moving:</span>
                        <input type="number" id="fastMovingFilter" class="filter-input" min="1" max="1000" value="20">
                        <span class="filter-label">products</span>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Slow Moving:</span>
                        <input type="number" id="slowMovingFilter" class="filter-input" min="1" max="1000" value="20">
                        <span class="filter-label">products</span>
                    </div>
                    <button id="applyFilters" class="filter-btn"><i class="fas fa-filter"></i> Apply</button>
                    <button id="resetFilters" class="filter-reset-btn"><i class="fas fa-redo"></i> Reset</button>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="fast-moving">Fast Moving <span class="tab-badge" id="fastMovingBadge">0</span></div>
                    <div class="tab" data-tab="slow-moving">Slow Moving <span class="tab-badge" id="slowMovingBadge">0</span></div>
                    <div class="tab" data-tab="cashiers">Cashiers</div>
                    <div class="tab" data-tab="categories">Categories</div>
                    <div class="tab" data-tab="customers">Top Customers</div>
                    <div class="tab" data-tab="road-to-target">Road to Target</div>
                </div>
                
                <!-- Fast Moving Tab -->
                <div id="fast-moving" class="tab-content active">
                    <div class="branch-filter-tabs" id="fastBranchFilter">
                        <button class="branch-filter-tab active" data-branch="all">All Branches</button>
                        <button class="branch-filter-tab" data-branch="Pharmacy POS">Syokimau</button>
                        <button class="branch-filter-tab" data-branch="Katani Pharmacy">Katani</button>
                    </div>
                    <div class="chart-container"><canvas id="fastMovingChart"></canvas></div>
                    <div class="stats-summary">
                        <div class="stat-item"><div class="stat-value" id="fastMovingTotal">0</div><div class="stat-label">Products</div></div>
                        <div class="stat-item"><div class="stat-value" id="fastMovingQty">0</div><div class="stat-label">Total Quantity</div></div>
                        <div class="stat-item"><div class="stat-value" id="fastMovingValue">KSh 0</div><div class="stat-label">Total Value</div></div>
                    </div>
                    <table id="fastMovingTable"><thead><tr><th>Product</th><th>Quantity Sold</th><th>Sales Value</th><th>Category</th><th>Days Sold</th></tr></thead><tbody id="fastMovingBody"><tr><td colspan="5" class="empty-state"><i class="fas fa-chart-bar"></i><h3>No Data Available</h3><p>Upload an Excel file to see fast moving products analysis</p></td></tr></tbody></table>
                </div>
                
                <!-- Slow Moving Tab -->
                <div id="slow-moving" class="tab-content">
                    <div class="branch-filter-tabs" id="slowBranchFilter">
                        <button class="branch-filter-tab active" data-branch="all">All Branches</button>
                        <button class="branch-filter-tab" data-branch="Pharmacy POS">Syokimau</button>
                        <button class="branch-filter-tab" data-branch="Katani Pharmacy">Katani</button>
                    </div>
                    <div class="chart-container"><canvas id="slowMovingChart"></canvas></div>
                    <div class="stats-summary">
                        <div class="stat-item"><div class="stat-value" id="slowMovingTotal">0</div><div class="stat-label">Products</div></div>
                        <div class="stat-item"><div class="stat-value" id="slowMovingQty">0</div><div class="stat-label">Total Quantity</div></div>
                        <div class="stat-item"><div class="stat-value" id="slowMovingValue">KSh 0</div><div class="stat-label">Total Value</div></div>
                    </div>
                    <table id="slowMovingTable"><thead><tr><th>Product</th><th>Quantity Sold</th><th>Sales Value</th><th>Category</th><th>Last Sold</th></tr></thead><tbody id="slowMovingBody"><tr><td colspan="5" class="empty-state"><i class="fas fa-chart-bar"></i><h3>No Data Available</h3><p>Upload an Excel file to see slow moving products analysis</p></td></tr></tbody></table>
                </div>
                
                <div id="cashiers" class="tab-content">
                    <div class="chart-container"><canvas id="cashiersChart"></canvas></div>
                    <table id="cashiersTable"><thead><tr><th>Cashier</th><th>Transactions</th><th>Total Sales</th><th>Avg Basket Value</th></tr></thead><tbody id="cashiersBody"><tr><td colspan="4" class="empty-state"><i class="fas fa-user-tie"></i><h3>No Data Available</h3><p>Upload an Excel file to see cashiers performance report</p></td></tr></tbody></table>
                </div>
                
                <div id="categories" class="tab-content">
                    <div class="chart-container"><canvas id="categoriesChart"></canvas></div>
                    <table id="categoriesTable"><thead><tr><th>Category</th><th>Products Sold</th><th>Sales Value</th><th>% of Total</th></tr></thead><tbody id="categoriesBody"><tr><td colspan="4" class="empty-state"><i class="fas fa-tags"></i><h3>No Data Available</h3><p>Upload an Excel file to see categories analysis</p></td></tr></tbody></table>
                </div>
                
                <div id="customers" class="tab-content">
                    <div class="chart-container"><canvas id="customersChart"></canvas></div>
                    <table id="customersTable"><thead><tr><th>Customer</th><th>Visits</th><th>Total Spent</th><th>Avg Spend</th></tr></thead><tbody id="customersBody"><tr><td colspan="4" class="empty-state"><i class="fas fa-user-friends"></i><h3>No Data Available</h3><p>Upload an Excel file to see top customers report</p></td></tr></tbody></table>
                </div>
                
                <!-- Road to Target Tab (Detailed Monthly) -->
                <div id="road-to-target" class="tab-content">
                    <div class="chart-container"><canvas id="targetChart"></canvas></div>
                    <div style="overflow-x: auto;">
                        <table class="target-table" id="targetTable">
                            <thead>
                                <tr>
                                    <th>Branch</th><th>Month</th><th>Daily Target</th><th>Full Month Target</th><th>Days in Month</th>
                                    <th>Days Covered</th><th>Actual Sales</th><th>Status</th><th>Achievement %</th><th>Variance</th>
                                    <th>Remaining Days</th><th>Needed to Target</th>
                                </tr>
                            </thead>
                            <tbody id="targetBody">
                                <tr><td colspan="12" class="empty-state"><i class="fas fa-bullseye"></i><h3>No Data Available</h3><p>Upload data and set date range to see road to target</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="reports-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-line"></i> Sales Trends & Growth</h2>
                </div>
                <div class="chart-container"><canvas id="salesTrendChart"></canvas></div>
                <div class="section-header" style="margin-top: 30px;">
                    <h2 class="section-title"><i class="fas fa-credit-card"></i> Payment Methods</h2>
                </div>
                <div class="chart-container"><canvas id="paymentChart"></canvas></div>
                
                <div class="growth-rate">
                    <h4>Growth Rate Analysis</h4>
                    <table class="growth-table">
                        <tr><td>Sales Growth (Period-over-Period)</td><td><span id="salesGrowth" class="growth-value positive">0%</span></td></tr>
                        <tr><td>Client Growth</td><td><span id="clientGrowth" class="growth-value positive">0%</span></td></tr>
                        <tr><td>Product Growth</td><td><span id="productGrowth" class="growth-value positive">0%</span></td></tr>
                        <tr><td>Basket Value Growth</td><td><span id="basketGrowth" class="growth-value positive">0%</span></td></tr>
                        <tr><td>Week-over-Week Sales</td><td><span id="weekOverWeek" class="growth-value positive">0%</span></td></tr>
                        <tr><td>Month-over-Month Sales</td><td><span id="monthOverMonth" class="growth-value positive">0%</span></td></tr>
                    </table>
                </div>
            </div>
        </div>
        <footer>Pharmacy Analytics Dashboard | Data updated in real-time</footer>
    </div>

    <script>
        // ==================== Global Variables ====================
        let originalData = [];
        let filteredData = [];
        let currentBranch = 'all';
        let startDate = null, endDate = null;
        let fastMovingCount = 20, slowMovingCount = 20;
        let fastBranch = 'all', slowBranch = 'all';
        
        // Chart instances
        let fastMovingChart, slowMovingChart, cashiersChart, categoriesChart, salesTrendChart, paymentChart, customersChart, targetChart;
        
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const branchButtons = document.querySelectorAll('.branch-btn');
        const applyDateButton = document.getElementById('applyDate');
        const exportReportButton = document.getElementById('exportReport');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const loaderProgress = document.getElementById('loaderProgress');
        const tabs = document.querySelectorAll('.tab');
        const notification = document.getElementById('notification');
        const dateDisplay = document.getElementById('dateDisplay');
        const dateRangeText = document.getElementById('dateRangeText');
        const fastMovingFilter = document.getElementById('fastMovingFilter');
        const slowMovingFilter = document.getElementById('slowMovingFilter');
        const applyFiltersButton = document.getElementById('applyFilters');
        const resetFiltersButton = document.getElementById('resetFilters');
        
        // Set default date range to last 30 days
        const today = new Date();
        const lastMonth = new Date(); lastMonth.setDate(today.getDate() - 30);
        startDateInput.valueAsDate = lastMonth;
        endDateInput.valueAsDate = today;
        startDate = lastMonth; endDate = today;
        
        // ==================== Target Data (Daily targets per month) ====================
        const targetData = {
            'Pharmacy POS': [25574, 25997, 28587, 33923, 39102, 40733, 45829, 52196, 52833, 59408, 66121, 72972],
            'Katani Pharmacy': [10000, 12000, 15000, 20000, 22000, 28000, 35000, 42000, 50000, 50000, 55000, 65000]
        };
        
        // Helper to get daily target for a specific date and branch
        function getDailyTarget(date, branch) {
            if (!date || !branch) return 0;
            const month = date.getMonth(); // 0-11
            if (branch === 'all') {
                return (targetData['Pharmacy POS'][month] || 0) + (targetData['Katani Pharmacy'][month] || 0);
            }
            return (targetData[branch] && targetData[branch][month]) || 0;
        }
        
        // Get number of days in a month (considering year for leap year)
        function daysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }
        
        // ==================== Helper Functions ====================
        function showNotification(title, message, type = 'success') {
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            const icon = notification.querySelector('i');
            if (type === 'success') { icon.className = 'fas fa-check-circle'; notification.style.borderLeftColor = 'var(--secondary-color)'; }
            else if (type === 'error') { icon.className = 'fas fa-exclamation-circle'; notification.style.borderLeftColor = 'var(--danger-color)'; }
            else if (type === 'warning') { icon.className = 'fas fa-exclamation-triangle'; notification.style.borderLeftColor = 'var(--warning-color)'; }
            else { icon.className = 'fas fa-info-circle'; notification.style.borderLeftColor = 'var(--primary-color)'; }
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 5000);
        }
        function updateLoaderProgress(percent, text) { loaderProgress.style.width = percent + '%'; if (text) loaderText.textContent = text; }
        function showLoader() { loader.classList.add('active'); }
        function hideLoader() { loader.classList.remove('active'); loaderProgress.style.width = '0%'; }
        function formatCurrency(amount) { return 'KSh ' + amount.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function formatCurrencyNumber(amount) { return amount.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function formatDate(date) { return date.toLocaleDateString('en-KE', { year: 'numeric', month: 'short', day: 'numeric' }); }
        function formatDateForDisplay(date) { return date.toLocaleDateString('en-KE', { month: 'short', day: 'numeric' }); }
        function formatMonthYear(date) { return date.toLocaleDateString('en-KE', { year: 'numeric', month: 'short' }); }
        
        // Walk-in customer detection
        function isWalkInCustomer(name) {
            if (!name || name.trim() === '') return true;
            const lower = name.toLowerCase();
            return lower.includes('walk') || lower.includes('cash') || lower.includes('customer') || lower.includes('anonymous') || lower === 'walk-in' || lower === 'walk in';
        }
        
        // ==================== Data Filtering ====================
        function filterData() {
            filteredData = originalData.filter(item => {
                if (currentBranch !== 'all') {
                    const sp = item.service_point || '';
                    if (currentBranch === 'Pharmacy POS' && !sp.includes('Pharmacy POS')) return false;
                    if (currentBranch === 'Katani Pharmacy' && !sp.includes('Katani Pharmacy')) return false;
                }
                if (startDate && endDate && item.parsedDate) {
                    const d = item.parsedDate;
                    const s = new Date(startDate); s.setHours(0,0,0,0);
                    const e = new Date(endDate); e.setHours(23,59,59,999);
                    if (d < s || d > e) return false;
                }
                return true;
            });
        }
        
        // Helper to filter original data by branch and date range (for growth)
        function getDataForPeriod(branch, start, end) {
            return originalData.filter(item => {
                if (branch !== 'all') {
                    const sp = item.service_point || '';
                    if (branch === 'Pharmacy POS' && !sp.includes('Pharmacy POS')) return false;
                    if (branch === 'Katani Pharmacy' && !sp.includes('Katani Pharmacy')) return false;
                }
                if (item.parsedDate) {
                    const d = item.parsedDate;
                    const s = new Date(start); s.setHours(0,0,0,0);
                    const e = new Date(end); e.setHours(23,59,59,999);
                    return d >= s && d <= e;
                }
                return false;
            });
        }
        
        // ==================== Growth Metrics ====================
        function calculateWeekOverWeekGrowth() {
            if (!startDate || !endDate || originalData.length === 0) return 0;
            const end = new Date(endDate);
            const currentWeekStart = new Date(end.getTime() - 6*24*60*60*1000);
            const currentWeekEnd = end;
            const prevWeekStart = new Date(currentWeekStart.getTime() - 7*24*60*60*1000);
            const prevWeekEnd = new Date(currentWeekStart.getTime() - 24*60*60*1000);
            
            const currentWeekData = getDataForPeriod(currentBranch, currentWeekStart, currentWeekEnd);
            const prevWeekData = getDataForPeriod(currentBranch, prevWeekStart, prevWeekEnd);
            
            const currentSales = currentWeekData.reduce((sum, i) => sum + (i.amount || 0), 0);
            const prevSales = prevWeekData.reduce((sum, i) => sum + (i.amount || 0), 0);
            
            if (prevSales === 0) return currentSales > 0 ? 100 : 0;
            return ((currentSales - prevSales) / prevSales) * 100;
        }
        
        function calculateMonthOverMonthGrowth() {
            if (!startDate || !endDate || originalData.length === 0) return 0;
            const end = new Date(endDate);
            const currentMonthStart = new Date(end.getTime() - 29*24*60*60*1000);
            const currentMonthEnd = end;
            const prevMonthStart = new Date(currentMonthStart.getTime() - 30*24*60*60*1000);
            const prevMonthEnd = new Date(currentMonthStart.getTime() - 24*60*60*1000);
            
            const currentMonthData = getDataForPeriod(currentBranch, currentMonthStart, currentMonthEnd);
            const prevMonthData = getDataForPeriod(currentBranch, prevMonthStart, prevMonthEnd);
            
            const currentSales = currentMonthData.reduce((sum, i) => sum + (i.amount || 0), 0);
            const prevSales = prevMonthData.reduce((sum, i) => sum + (i.amount || 0), 0);
            
            if (prevSales === 0) return currentSales > 0 ? 100 : 0;
            return ((currentSales - prevSales) / prevSales) * 100;
        }
        
        function calculatePeriodOverPeriodGrowth(metric) {
            if (!startDate || !endDate || originalData.length === 0) return 0;
            const periodLength = endDate.getTime() - startDate.getTime();
            const prevStart = new Date(startDate.getTime() - periodLength - 24*60*60*1000);
            const prevEnd = new Date(startDate.getTime() - 24*60*60*1000);
            
            const currentData = filteredData;
            const prevData = getDataForPeriod(currentBranch, prevStart, prevEnd);
            
            let currVal, prevVal;
            switch(metric) {
                case 'sales':
                    currVal = currentData.reduce((s,i)=>s+(i.amount||0),0);
                    prevVal = prevData.reduce((s,i)=>s+(i.amount||0),0);
                    break;
                case 'clients':
                    currVal = new Set(currentData.map(i=>i.invoice_no)).size;
                    prevVal = new Set(prevData.map(i=>i.invoice_no)).size;
                    break;
                case 'products':
                    currVal = currentData.reduce((s,i)=>s+(i.qty||0),0);
                    prevVal = prevData.reduce((s,i)=>s+(i.qty||0),0);
                    break;
                case 'basket':
                    currVal = calculateAverageBasketValue(currentData);
                    prevVal = calculateAverageBasketValue(prevData);
                    break;
                default: return 0;
            }
            if (prevVal === 0) return currVal > 0 ? 100 : 0;
            return ((currVal - prevVal) / prevVal) * 100;
        }
        
        // ==================== Customer Type Counts ====================
        function getRegisteredCustomersCount() {
            const customers = new Set();
            filteredData.forEach(item => {
                const name = item.customer_name;
                if (name && !isWalkInCustomer(name)) customers.add(name);
            });
            return customers.size;
        }
        function getWalkInCustomersCount() {
            const customers = new Set();
            filteredData.forEach(item => {
                const name = item.customer_name;
                if (!name || isWalkInCustomer(name)) customers.add(name || 'Walk-in');
            });
            return customers.size;
        }
        
        // ==================== Branch-specific fast/slow with extra fields ====================
        function getFastMovingProductsForBranch(branch, limit = fastMovingCount) {
            const data = branch === 'all' ? filteredData : filteredData.filter(item => {
                const sp = item.service_point || '';
                return branch === 'Pharmacy POS' ? sp.includes('Pharmacy POS') : sp.includes('Katani Pharmacy');
            });
            const prod = {};
            data.forEach(item => {
                const p = item.product || 'Unknown';
                const q = item.qty || 0;
                const a = item.amount || 0;
                const cat = item.category || 'Unknown';
                const dateStr = item.parsedDate ? item.parsedDate.toISOString().split('T')[0] : '';
                if (!prod[p]) prod[p] = { qty: 0, amount: 0, category: cat, days: new Set() };
                prod[p].qty += q;
                prod[p].amount += a;
                if (dateStr) prod[p].days.add(dateStr);
            });
            return Object.entries(prod).map(([name, d]) => ({
                Product: name,
                'Quantity Sold': d.qty,
                'Sales Value': d.amount,
                Category: d.category,
                'Days Sold': d.days.size
            })).filter(p => p['Quantity Sold'] > 0).sort((a,b) => b['Quantity Sold'] - a['Quantity Sold']).slice(0, limit);
        }
        
        function getSlowMovingProductsForBranch(branch, limit = slowMovingCount) {
            const data = branch === 'all' ? filteredData : filteredData.filter(item => {
                const sp = item.service_point || '';
                return branch === 'Pharmacy POS' ? sp.includes('Pharmacy POS') : sp.includes('Katani Pharmacy');
            });
            const prod = {};
            data.forEach(item => {
                const p = item.product || 'Unknown';
                const q = item.qty || 0;
                const a = item.amount || 0;
                const cat = item.category || 'Unknown';
                const date = item.parsedDate;
                if (!prod[p]) prod[p] = { qty: 0, amount: 0, category: cat, lastDate: null };
                prod[p].qty += q;
                prod[p].amount += a;
                if (date && (!prod[p].lastDate || date > prod[p].lastDate)) prod[p].lastDate = date;
            });
            return Object.entries(prod).map(([name, d]) => ({
                Product: name,
                'Quantity Sold': d.qty,
                'Sales Value': d.amount,
                Category: d.category,
                'Last Sold': d.lastDate
            })).filter(p => p['Quantity Sold'] > 0).sort((a,b) => a['Quantity Sold'] - b['Quantity Sold']).slice(0, limit);
        }
        
        // ==================== Update Functions ====================
        function updateSummaryCards() {
            const totalSales = filteredData.reduce((s,i) => s + (i.amount||0), 0);
            const uniqueInvoices = new Set(filteredData.map(i => i.invoice_no)).size;
            const totalQty = filteredData.reduce((s,i) => s + (i.qty||0), 0);
            const avgBasket = calculateAverageBasketValue(filteredData);
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('clientsCount').textContent = uniqueInvoices.toLocaleString();
            document.getElementById('basketValue').textContent = formatCurrency(avgBasket);
            document.getElementById('productsCount').textContent = totalQty.toLocaleString();
            
            document.getElementById('registeredCount').textContent = getRegisteredCustomersCount().toLocaleString();
            document.getElementById('walkinCount').textContent = getWalkInCustomersCount().toLocaleString();
            
            const salesGrowth = calculatePeriodOverPeriodGrowth('sales');
            const clientsGrowth = calculatePeriodOverPeriodGrowth('clients');
            const basketGrowth = calculatePeriodOverPeriodGrowth('basket');
            const productsGrowth = calculatePeriodOverPeriodGrowth('products');
            updateChangeIndicator('salesChange', salesGrowth);
            updateChangeIndicator('clientsChange', clientsGrowth);
            updateChangeIndicator('basketChange', basketGrowth);
            updateChangeIndicator('productsChange', productsGrowth);
            
            const wow = calculateWeekOverWeekGrowth();
            const mom = calculateMonthOverMonthGrowth();
            document.getElementById('weekOverWeek').textContent = wow.toFixed(1) + '%';
            document.getElementById('monthOverMonth').textContent = mom.toFixed(1) + '%';
            document.getElementById('weekOverWeek').className = wow >=0 ? 'growth-value positive' : 'growth-value negative';
            document.getElementById('monthOverMonth').className = mom >=0 ? 'growth-value positive' : 'growth-value negative';
        }
        
        function calculateAverageBasketValue(data = filteredData) {
            const inv = {}; data.forEach(i => { let ino = i.invoice_no; if (!inv[ino]) inv[ino] = 0; inv[ino] += i.amount||0; });
            const total = Object.values(inv).reduce((a,b)=>a+b,0);
            return Object.keys(inv).length ? total / Object.keys(inv).length : 0;
        }
        
        function updateChangeIndicator(id, val) {
            const el = document.getElementById(id);
            if (!el) return;
            const arrow = val >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            el.innerHTML = `<i class="fas ${arrow}"></i> ${Math.abs(val).toFixed(1)}%`;
            el.className = `card-change ${val>=0?'positive':'negative'}`;
        }
        
        function updateFastMovingProducts() {
            const branch = fastBranch;
            const data = getFastMovingProductsForBranch(branch, fastMovingCount);
            document.getElementById('fastMovingBadge').textContent = data.length;
            const tbody = document.getElementById('fastMovingBody');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-chart-bar"></i><h3>No Data</h3><p>No fast moving products for this branch.</p></td></tr>';
            } else {
                data.forEach((item, idx) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td><span class="product-badge badge-fast">#${idx+1}</span> ${item.Product}</td>
                                    <td>${item['Quantity Sold'].toLocaleString()}</td>
                                    <td>${formatCurrency(item['Sales Value'])}</td>
                                    <td>${item.Category}</td>
                                    <td>${item['Days Sold']}</td>`;
                });
            }
            document.getElementById('fastMovingTotal').textContent = data.length;
            const totalQty = data.reduce((s,i)=>s+i['Quantity Sold'],0);
            const totalVal = data.reduce((s,i)=>s+i['Sales Value'],0);
            document.getElementById('fastMovingQty').textContent = totalQty.toLocaleString();
            document.getElementById('fastMovingValue').textContent = formatCurrency(totalVal);
            
            const chartData = data.slice(0,15);
            fastMovingChart.data.labels = chartData.map(i => i.Product.length>20 ? i.Product.substr(0,20)+'' : i.Product);
            fastMovingChart.data.datasets[0].data = chartData.map(i => i['Quantity Sold']);
            fastMovingChart.options.plugins.title.text = `Top ${fastMovingCount} Fast Moving Products - ${branch === 'all' ? 'All Branches' : (branch==='Pharmacy POS'?'Syokimau':'Katani')}`;
            fastMovingChart.update();
        }
        
        function updateSlowMovingProducts() {
            const branch = slowBranch;
            const data = getSlowMovingProductsForBranch(branch, slowMovingCount);
            document.getElementById('slowMovingBadge').textContent = data.length;
            const tbody = document.getElementById('slowMovingBody');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-chart-bar"></i><h3>No Data</h3><p>No slow moving products for this branch.</p></td></tr>';
            } else {
                data.forEach((item, idx) => {
                    const row = tbody.insertRow();
                    const lastSold = item['Last Sold'] ? formatDate(item['Last Sold']) : 'N/A';
                    row.innerHTML = `<td><span class="product-badge badge-slow">#${idx+1}</span> ${item.Product}</td>
                                    <td>${item['Quantity Sold'].toLocaleString()}</td>
                                    <td>${formatCurrency(item['Sales Value'])}</td>
                                    <td>${item.Category}</td>
                                    <td>${lastSold}</td>`;
                });
            }
            document.getElementById('slowMovingTotal').textContent = data.length;
            const totalQty = data.reduce((s,i)=>s+i['Quantity Sold'],0);
            const totalVal = data.reduce((s,i)=>s+i['Sales Value'],0);
            document.getElementById('slowMovingQty').textContent = totalQty.toLocaleString();
            document.getElementById('slowMovingValue').textContent = formatCurrency(totalVal);
            
            const chartData = data.slice(0,15);
            slowMovingChart.data.labels = chartData.map(i => i.Product.length>20 ? i.Product.substr(0,20)+'' : i.Product);
            slowMovingChart.data.datasets[0].data = chartData.map(i => i['Quantity Sold']);
            slowMovingChart.options.plugins.title.text = `Top ${slowMovingCount} Slow Moving Products - ${branch === 'all' ? 'All Branches' : (branch==='Pharmacy POS'?'Syokimau':'Katani')}`;
            slowMovingChart.update();
        }
        
        function updateCashiersReport() {
            const cash = {}; filteredData.forEach(i => { let c = i.user || 'Unknown'; if(!cash[c]) cash[c]={trans:0,amt:0,inv:new Set()}; cash[c].trans++; cash[c].amt+=i.amount||0; if(i.invoice_no) cash[c].inv.add(i.invoice_no); });
            const arr = Object.entries(cash).map(([name,d]) => ({ Cashier: name, Transactions: d.trans, 'Total Sales': d.amt, 'Avg Basket Value': d.inv.size ? d.amt/d.inv.size : 0 })).sort((a,b)=>b['Total Sales']-a['Total Sales']);
            const tbody = document.getElementById('cashiersBody'); tbody.innerHTML = '';
            arr.forEach(i => { let r = tbody.insertRow(); r.innerHTML = `<td>${i.Cashier}</td><td>${i.Transactions}</td><td>${formatCurrency(i['Total Sales'])}</td><td>${formatCurrency(i['Avg Basket Value'])}</td>`; });
            const top = arr.slice(0,6);
            cashiersChart.data.labels = top.map(i=>i.Cashier);
            cashiersChart.data.datasets[0].data = top.map(i=>i['Total Sales']);
            cashiersChart.update();
        }
        
        function updateCategoriesReport() {
            const cat = {}; let total = 0; filteredData.forEach(i => { let c = i.category || 'Unknown'; let a = i.amount||0; let q = i.qty||0; if(!cat[c]) cat[c]={amt:0,qty:0}; cat[c].amt+=a; cat[c].qty+=q; total+=a; });
            const arr = Object.entries(cat).map(([c,d]) => ({ Category: c, 'Products Sold': d.qty, 'Sales Value': d.amt, '% of Total': total ? (d.amt/total*100) : 0 })).sort((a,b)=>b['Sales Value']-a['Sales Value']);
            const tbody = document.getElementById('categoriesBody'); tbody.innerHTML = '';
            arr.forEach(i => { let r = tbody.insertRow(); r.innerHTML = `<td>${i.Category}</td><td>${i['Products Sold']}</td><td>${formatCurrency(i['Sales Value'])}</td><td>${i['% of Total'].toFixed(1)}%</td>`; });
            const top = arr.slice(0,8);
            categoriesChart.data.labels = top.map(i=>i.Category);
            categoriesChart.data.datasets[0].data = top.map(i=>i['Sales Value']);
            categoriesChart.update();
        }
        
        function updateCustomersReport() {
            const cust = {}; filteredData.forEach(i => { let n = i.customer_name || 'Unknown'; let a = i.amount||0; let inv = i.invoice_no; if(!cust[n]) cust[n]={amt:0,inv:new Set()}; cust[n].amt+=a; if(inv) cust[n].inv.add(inv); });
            const arr = Object.entries(cust).map(([n,d]) => ({ Customer: n, Visits: d.inv.size, 'Total Spent': d.amt, 'Avg Spend': d.inv.size ? d.amt/d.inv.size : 0 })).sort((a,b)=>b['Total Spent']-a['Total Spent']).slice(0,20);
            const tbody = document.getElementById('customersBody'); tbody.innerHTML = '';
            arr.forEach(i => { let r = tbody.insertRow(); r.innerHTML = `<td>${i.Customer}</td><td>${i.Visits}</td><td>${formatCurrency(i['Total Spent'])}</td><td>${formatCurrency(i['Avg Spend'])}</td>`; });
            const top10 = arr.slice(0,10);
            customersChart.data.labels = top10.map(i=>i.Customer);
            customersChart.data.datasets[0].data = top10.map(i=>i['Total Spent']);
            customersChart.update();
        }
        
        function updateSalesTrend() {
            const daily = {}; filteredData.forEach(i => { if(i.parsedDate) { let d = i.parsedDate.toISOString().split('T')[0]; daily[d] = (daily[d]||0) + (i.amount||0); } });
            const sorted = Object.keys(daily).sort().slice(-30);
            salesTrendChart.data.labels = sorted.map(d => formatDateForDisplay(new Date(d)));
            salesTrendChart.data.datasets[0].data = sorted.map(d => daily[d]);
            salesTrendChart.update();
        }
        
        function updatePaymentMethods() {
            const pay = {}; filteredData.forEach(i => { let p = i.payment_mode || 'Unknown'; pay[p] = (pay[p]||0)+1; });
            const arr = Object.entries(pay).map(([m,c]) => ({method:m,count:c})).sort((a,b)=>b.count-a.count);
            paymentChart.data.labels = arr.map(i=>i.method);
            paymentChart.data.datasets[0].data = arr.map(i=>i.count);
            paymentChart.update();
        }
        
        function updateGrowthRates() {
            document.getElementById('salesGrowth').textContent = calculatePeriodOverPeriodGrowth('sales').toFixed(1)+'%';
            document.getElementById('clientGrowth').textContent = calculatePeriodOverPeriodGrowth('clients').toFixed(1)+'%';
            document.getElementById('productGrowth').textContent = calculatePeriodOverPeriodGrowth('products').toFixed(1)+'%';
            document.getElementById('basketGrowth').textContent = calculatePeriodOverPeriodGrowth('basket').toFixed(1)+'%';
            const wow = calculateWeekOverWeekGrowth();
            const mom = calculateMonthOverMonthGrowth();
            document.getElementById('weekOverWeek').textContent = wow.toFixed(1) + '%';
            document.getElementById('monthOverMonth').textContent = mom.toFixed(1) + '%';
            document.getElementById('weekOverWeek').className = wow >=0 ? 'growth-value positive' : 'growth-value negative';
            document.getElementById('monthOverMonth').className = mom >=0 ? 'growth-value positive' : 'growth-value negative';
        }
        
        // New detailed Road to Target update
        function updateRoadToTarget() {
            if (!startDate || !endDate || filteredData.length === 0) {
                document.getElementById('targetBody').innerHTML = '<tr><td colspan="12" class="empty-state"><i class="fas fa-bullseye"></i><h3>No Data Available</h3><p>Upload data and set date range to see road to target</p></td></tr>';
                if (targetChart) {
                    targetChart.data.labels = [];
                    targetChart.data.datasets[0].data = [];
                    targetChart.data.datasets[1].data = [];
                    targetChart.update();
                }
                return;
            }
            
            // Determine which branches to show
            let branchesToShow = [];
            if (currentBranch === 'all') {
                branchesToShow = ['Pharmacy POS', 'Katani Pharmacy'];
            } else {
                branchesToShow = [currentBranch];
            }
            
            // Generate all month-years between start and end
            const start = new Date(startDate);
            const end = new Date(endDate);
            start.setHours(0,0,0,0);
            end.setHours(23,59,59,999);
            
            const months = [];
            const current = new Date(start.getFullYear(), start.getMonth(), 1);
            while (current <= end) {
                months.push(new Date(current));
                current.setMonth(current.getMonth() + 1);
            }
            
            // Collect rows for table
            let rows = [];
            let chartLabels = [];
            let chartActual = [];
            let chartTarget = [];
            
            months.forEach(monthDate => {
                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month + 1, 0, 23, 59, 59, 999);
                const daysInMonthNum = daysInMonth(year, month);
                
                branchesToShow.forEach(branch => {
                    // Clamp to date range
                    const rangeStart = monthStart < start ? start : monthStart;
                    const rangeEnd = monthEnd > end ? end : monthEnd;
                    if (rangeStart > rangeEnd) return; // no overlap
                    
                    const daysCovered = Math.floor((rangeEnd - rangeStart) / (1000*60*60*24)) + 1;
                    if (daysCovered <= 0) return;
                    
                    // Get daily target for this branch and month
                    const dailyTarget = getDailyTarget(new Date(year, month, 1), branch);
                    
                    // Prorated target for covered days
                    const proratedTarget = dailyTarget * daysCovered;
                    const fullMonthTarget = dailyTarget * daysInMonthNum;
                    
                    // Actual sales for this branch in this month-year within the range
                    const actual = filteredData
                        .filter(item => {
                            if (!item.parsedDate) return false;
                            if (branch !== 'all') {
                                const sp = item.service_point || '';
                                if (branch === 'Pharmacy POS' && !sp.includes('Pharmacy POS')) return false;
                                if (branch === 'Katani Pharmacy' && !sp.includes('Katani Pharmacy')) return false;
                            }
                            const d = item.parsedDate;
                            return d >= rangeStart && d <= rangeEnd;
                        })
                        .reduce((sum, i) => sum + (i.amount || 0), 0);
                    
                    const status = daysCovered === daysInMonthNum ? 'Complete' : 'Incomplete';
                    const achievement = proratedTarget > 0 ? (actual / proratedTarget * 100) : 0;
                    const variance = actual - proratedTarget;
                    const remainingDays = daysInMonthNum - daysCovered;
                    const neededToTarget = fullMonthTarget - actual; // could be negative if already exceeded
                    
                    const branchName = branch === 'Pharmacy POS' ? 'Syokimau' : (branch === 'Katani Pharmacy' ? 'Katani' : branch);
                    
                    rows.push({
                        branch: branchName,
                        month: formatMonthYear(monthDate),
                        dailyTarget: dailyTarget,
                        fullMonthTarget: fullMonthTarget,
                        daysInMonth: daysInMonthNum,
                        daysCovered: daysCovered,
                        actual: actual,
                        status: status,
                        achievement: achievement,
                        variance: variance,
                        remainingDays: remainingDays,
                        needed: neededToTarget
                    });
                    
                    // For chart (if showing this branch or combined)
                    if (branch === currentBranch || currentBranch === 'all') {
                        // For 'all', we combine both branches into one row per month? Let's combine for chart simplicity.
                        // We'll handle in next step.
                    }
                });
            });
            
            // If currentBranch is 'all', we might want to combine rows per month for chart
            if (currentBranch === 'all') {
                // Group by month and sum actual and full target
                const monthMap = new Map();
                rows.forEach(row => {
                    const key = row.month;
                    if (!monthMap.has(key)) {
                        monthMap.set(key, { month: row.month, actual: 0, fullTarget: 0 });
                    }
                    const entry = monthMap.get(key);
                    entry.actual += row.actual;
                    entry.fullTarget += row.fullMonthTarget;
                });
                chartLabels = Array.from(monthMap.values()).map(e => e.month);
                chartActual = Array.from(monthMap.values()).map(e => e.actual);
                chartTarget = Array.from(monthMap.values()).map(e => e.fullTarget);
            } else {
                // Filter rows for selected branch
                const branchRows = rows.filter(r => r.branch === (currentBranch === 'Pharmacy POS' ? 'Syokimau' : 'Katani'));
                chartLabels = branchRows.map(r => r.month);
                chartActual = branchRows.map(r => r.actual);
                chartTarget = branchRows.map(r => r.fullMonthTarget);
            }
            
            // Build table HTML
            let tbodyHtml = '';
            rows.forEach(r => {
                const statusClass = r.status === 'Complete' ? 'status-complete' : 'status-incomplete';
                const achievementClass = r.achievement >= 100 ? 'achieved' : 'missed';
                const varianceClass = r.variance >= 0 ? 'achieved' : 'missed';
                const neededClass = r.needed >= 0 ? 'missed' : 'achieved'; // if needed positive, we need to sell more (missed), else already achieved
                tbodyHtml += `<tr>
                    <td>${r.branch}</td>
                    <td>${r.month}</td>
                    <td>${formatCurrency(r.dailyTarget)}</td>
                    <td>${formatCurrency(r.fullMonthTarget)}</td>
                    <td>${r.daysInMonth}</td>
                    <td>${r.daysCovered}</td>
                    <td>${formatCurrency(r.actual)}</td>
                    <td><span class="status-badge ${statusClass}">${r.status}</span></td>
                    <td class="${achievementClass}">${r.achievement.toFixed(1)}%</td>
                    <td class="${varianceClass}">${formatCurrency(r.variance)}</td>
                    <td>${r.remainingDays}</td>
                    <td class="${neededClass}">${formatCurrency(r.needed)}</td>
                </tr>`;
            });
            if (tbodyHtml === '') {
                tbodyHtml = '<tr><td colspan="12" class="empty-state"><i class="fas fa-bullseye"></i><h3>No Data</h3><p>No months in selected range.</p></td></tr>';
            }
            document.getElementById('targetBody').innerHTML = tbodyHtml;
            
            // Update chart
            if (targetChart) {
                targetChart.data.labels = chartLabels;
                targetChart.data.datasets[0].data = chartActual;
                targetChart.data.datasets[1].data = chartTarget;
                targetChart.update();
            }
        }
        
        function updateDashboard() {
            if (filteredData.length === 0) { 
                // Optionally reset displays
                return; 
            }
            updateSummaryCards();
            updateFastMovingProducts();
            updateSlowMovingProducts();
            updateCashiersReport();
            updateCategoriesReport();
            updateCustomersReport();
            updateSalesTrend();
            updatePaymentMethods();
            updateGrowthRates();
            updateRoadToTarget();
        }
        
        // ==================== Initialize Charts ====================
        function initializeCharts() {
            fastMovingChart = new Chart(document.getElementById('fastMovingChart'), {
                type: 'bar', data: { labels: [], datasets: [{ label: 'Quantity Sold', data: [], backgroundColor: 'rgba(52, 152, 219, 0.8)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Fast Moving Products' } } }
            });
            slowMovingChart = new Chart(document.getElementById('slowMovingChart'), {
                type: 'bar', data: { labels: [], datasets: [{ label: 'Quantity Sold', data: [], backgroundColor: 'rgba(231, 76, 60, 0.8)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Slow Moving Products' } } }
            });
            cashiersChart = new Chart(document.getElementById('cashiersChart'), {
                type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3498db','#2ecc71','#9b59b6','#f1c40f','#e67e22','#e74c3c'] }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Sales by Cashier' } } }
            });
            categoriesChart = new Chart(document.getElementById('categoriesChart'), {
                type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3498db','#2ecc71','#9b59b6','#f1c40f','#e67e22','#e74c3c','#95a5a6','#2c3e50'] }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Sales by Category' } } }
            });
            salesTrendChart = new Chart(document.getElementById('salesTrendChart'), {
                type: 'line', data: { labels: [], datasets: [{ label: 'Daily Sales', data: [], borderColor: '#3498db', backgroundColor: 'rgba(52,152,219,0.1)', tension: 0.3 }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Sales Trend' } } }
            });
            paymentChart = new Chart(document.getElementById('paymentChart'), {
                type: 'polarArea', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3498db','#2ecc71','#9b59b6','#f1c40f','#e67e22'] }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Payment Methods' } } }
            });
            customersChart = new Chart(document.getElementById('customersChart'), {
                type: 'bar', data: { labels: [], datasets: [{ label: 'Total Spent', data: [], backgroundColor: '#9b59b6' }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Top Customers' } } }
            });
            targetChart = new Chart(document.getElementById('targetChart'), {
                type: 'bar', data: { 
                    labels: [], 
                    datasets: [
                        { label: 'Actual Sales', data: [], backgroundColor: '#3498db' },
                        { label: 'Full Month Target', data: [], backgroundColor: '#e74c3c' }
                    ] 
                },
                options: { 
                    responsive: true, 
                    plugins: { title: { display: true, text: 'Actual vs Target by Month' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        // ==================== Event Listeners ====================
        document.addEventListener('DOMContentLoaded', initializeCharts);
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            showLoader(); loaderText.textContent = 'Reading Excel...'; updateLoaderProgress(10);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateLoaderProgress(30, 'Processing...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    updateLoaderProgress(50, 'Converting...');
                    const headers = json[0];
                    originalData = [];
                    for (let i=1; i<json.length; i++) {
                        let row = json[i]; let obj = {};
                        headers.forEach((h, idx) => obj[h] = row[idx]);
                        obj.amount = parseFloat(obj.amount) || 0;
                        obj.qty = parseFloat(obj.qty) || 0;
                        if (obj.date) {
                            let ds = obj.date.toString();
                            if (ds.includes('/')) { let p = ds.split(' ')[0].split('/'); if(p.length===3) obj.parsedDate = new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0])); }
                            else obj.parsedDate = new Date(obj.date);
                            if (isNaN(obj.parsedDate)) obj.parsedDate = new Date();
                        } else obj.parsedDate = new Date();
                        originalData.push(obj);
                    }
                    originalData = originalData.filter(i => (i.service_point||'').includes('Pharmacy POS') || (i.service_point||'').includes('Katani Pharmacy'));
                    if (originalData.length) {
                        const dates = originalData.map(i=>i.parsedDate).filter(d=>d);
                        const min = new Date(Math.min(...dates.map(d=>d.getTime())));
                        const max = new Date(Math.max(...dates.map(d=>d.getTime())));
                        dateDisplay.classList.add('active');
                        dateRangeText.textContent = `${formatDate(min)} to ${formatDate(max)}`;
                        startDateInput.valueAsDate = min; endDateInput.valueAsDate = max; startDate=min; endDate=max;
                    }
                    filterData();
                    updateDashboard();
                    hideLoader();
                    showNotification('Data Loaded', `Loaded ${originalData.length} records`);
                } catch (err) { hideLoader(); showNotification('Error', 'Invalid file', 'error'); }
            };
            reader.readAsArrayBuffer(file);
        });
        
        branchButtons.forEach(b => b.addEventListener('click', function() {
            branchButtons.forEach(btn => btn.classList.remove('active')); this.classList.add('active');
            currentBranch = this.dataset.branch;
            filterData(); updateDashboard();
        }));
        
        applyDateButton.addEventListener('click', function() {
            startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            if (startDate && endDate && startDate > endDate) { showNotification('Warning', 'Start after end', 'warning'); return; }
            filterData(); updateDashboard(); showNotification('Filter Applied', 'Date filter updated', 'info');
        });
        
        tabs.forEach(tab => tab.addEventListener('click', function() {
            tabs.forEach(t=>t.classList.remove('active')); this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById(this.dataset.tab).classList.add('active');
        }));
        
        document.querySelectorAll('#fastBranchFilter .branch-filter-tab').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#fastBranchFilter .branch-filter-tab').forEach(b=>b.classList.remove('active'));
                this.classList.add('active');
                fastBranch = this.dataset.branch;
                updateFastMovingProducts();
            });
        });
        document.querySelectorAll('#slowBranchFilter .branch-filter-tab').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#slowBranchFilter .branch-filter-tab').forEach(b=>b.classList.remove('active'));
                this.classList.add('active');
                slowBranch = this.dataset.branch;
                updateSlowMovingProducts();
            });
        });
        
        applyFiltersButton.addEventListener('click', function() {
            fastMovingCount = parseInt(fastMovingFilter.value) || 20; if (fastMovingCount<1) fastMovingCount=1; if (fastMovingCount>1000) fastMovingCount=1000;
            slowMovingCount = parseInt(slowMovingFilter.value) || 20; if (slowMovingCount<1) slowMovingCount=1; if (slowMovingCount>1000) slowMovingCount=1000;
            fastMovingFilter.value = fastMovingCount; slowMovingFilter.value = slowMovingCount;
            updateFastMovingProducts(); updateSlowMovingProducts();
            showNotification('Filters Applied', `Fast:${fastMovingCount}, Slow:${slowMovingCount}`);
        });
        
        resetFiltersButton.addEventListener('click', function() {
            fastMovingCount=20; slowMovingCount=20;
            fastMovingFilter.value=20; slowMovingFilter.value=20;
            updateFastMovingProducts(); updateSlowMovingProducts();
            showNotification('Filters Reset', 'Default 20 products');
        });
        
        // ==================== Export with detailed Road to Target ====================
        exportReportButton.addEventListener('click', function() {
            if (filteredData.length === 0) { showNotification('Warning', 'No data to export', 'warning'); return; }
            showLoader(); loaderText.textContent = 'Generating export...'; updateLoaderProgress(10);
            try {
                const wb = XLSX.utils.book_new();
                
                // Summary
                const summary = [{
                    'Total Sales': formatCurrencyNumber(filteredData.reduce((s,i)=>s+(i.amount||0),0)),
                    'Total Customers (Invoices)': new Set(filteredData.map(i=>i.invoice_no)).size,
                    'Registered Customers': getRegisteredCustomersCount(),
                    'Walk-in Customers': getWalkInCustomersCount(),
                    'Total Products Sold': filteredData.reduce((s,i)=>s+(i.qty||0),0),
                    'Avg Basket': formatCurrencyNumber(calculateAverageBasketValue()),
                    'Date Range': dateRangeText.textContent,
                    'Branch Filter': currentBranch==='all'?'All':(currentBranch==='Pharmacy POS'?'Syokimau':'Katani')
                }];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summary), "Summary");
                
                // Fast Moving per branch (with Days Sold)
                ['all','Pharmacy POS','Katani Pharmacy'].forEach(b => {
                    let data = getFastMovingProductsForBranch(b, fastMovingCount).map(p => ({ 
                        ...p, 
                        'Sales Value': formatCurrencyNumber(p['Sales Value']),
                        'Days Sold': p['Days Sold']
                    }));
                    let name = b==='all'?'AllBranches':(b==='Pharmacy POS'?'Syokimau':'Katani');
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), `Fast_${name}`);
                });
                
                // Slow Moving per branch (with Last Sold)
                ['all','Pharmacy POS','Katani Pharmacy'].forEach(b => {
                    let data = getSlowMovingProductsForBranch(b, slowMovingCount).map(p => ({ 
                        ...p, 
                        'Sales Value': formatCurrencyNumber(p['Sales Value']),
                        'Last Sold': p['Last Sold'] ? formatDate(p['Last Sold']) : 'N/A'
                    }));
                    let name = b==='all'?'AllBranches':(b==='Pharmacy POS'?'Syokimau':'Katani');
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), `Slow_${name}`);
                });
                
                // Cashiers
                let cash = getCashiersReport().map(c => ({ ...c, 'Total Sales': formatCurrencyNumber(c['Total Sales']), 'Avg Basket Value': formatCurrencyNumber(c['Avg Basket Value']) }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cash), "Cashiers");
                
                // Categories
                let cat = getCategoriesReport().map(c => ({ ...c, 'Sales Value': formatCurrencyNumber(c['Sales Value']), '% of Total': c['% of Total'].toFixed(2)+'%' }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cat), "Categories");
                
                // Customers
                let cust = getCustomersReport().map(c => ({ ...c, 'Total Spent': formatCurrencyNumber(c['Total Spent']), 'Avg Spend': formatCurrencyNumber(c['Avg Spend']) }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cust), "TopCustomers");
                
                // Growth Rates
                let growth = [
                    { Metric: 'Sales Growth (Period)', Value: calculatePeriodOverPeriodGrowth('sales').toFixed(1)+'%' },
                    { Metric: 'Client Growth', Value: calculatePeriodOverPeriodGrowth('clients').toFixed(1)+'%' },
                    { Metric: 'Product Growth', Value: calculatePeriodOverPeriodGrowth('products').toFixed(1)+'%' },
                    { Metric: 'Basket Growth', Value: calculatePeriodOverPeriodGrowth('basket').toFixed(1)+'%' },
                    { Metric: 'Week-over-Week Sales', Value: calculateWeekOverWeekGrowth().toFixed(1)+'%' },
                    { Metric: 'Month-over-Month Sales', Value: calculateMonthOverMonthGrowth().toFixed(1)+'%' }
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(growth), "Growth");
                
                // Customer Types
                let custTypes = [
                    { Type: 'Registered Customers', Count: getRegisteredCustomersCount() },
                    { Type: 'Walk-in Customers', Count: getWalkInCustomersCount() }
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(custTypes), "CustomerTypes");
                
                // Road to Target - Detailed
                // Recompute rows similarly to updateRoadToTarget but export all branches even if current is specific? Better to export all branches always for completeness.
                const exportBranches = ['Pharmacy POS', 'Katani Pharmacy'];
                const startExp = new Date(startDate);
                const endExp = new Date(endDate);
                startExp.setHours(0,0,0,0);
                endExp.setHours(23,59,59,999);
                const monthsExp = [];
                const currentExp = new Date(startExp.getFullYear(), startExp.getMonth(), 1);
                while (currentExp <= endExp) {
                    monthsExp.push(new Date(currentExp));
                    currentExp.setMonth(currentExp.getMonth() + 1);
                }
                let targetRows = [];
                monthsExp.forEach(monthDate => {
                    const year = monthDate.getFullYear();
                    const month = monthDate.getMonth();
                    const monthStart = new Date(year, month, 1);
                    const monthEnd = new Date(year, month + 1, 0, 23, 59, 59, 999);
                    const daysInMonthNum = daysInMonth(year, month);
                    
                    exportBranches.forEach(branch => {
                        const rangeStart = monthStart < startExp ? startExp : monthStart;
                        const rangeEnd = monthEnd > endExp ? endExp : monthEnd;
                        if (rangeStart > rangeEnd) return;
                        
                        const daysCovered = Math.floor((rangeEnd - rangeStart) / (1000*60*60*24)) + 1;
                        const dailyTarget = getDailyTarget(new Date(year, month, 1), branch);
                        const proratedTarget = dailyTarget * daysCovered;
                        const fullMonthTarget = dailyTarget * daysInMonthNum;
                        
                        const actual = originalData // use original to include all data, not just filtered? We'll use filtered for consistency with dashboard.
                            .filter(item => {
                                if (!item.parsedDate) return false;
                                const sp = item.service_point || '';
                                if (branch === 'Pharmacy POS' && !sp.includes('Pharmacy POS')) return false;
                                if (branch === 'Katani Pharmacy' && !sp.includes('Katani Pharmacy')) return false;
                                const d = item.parsedDate;
                                return d >= rangeStart && d <= rangeEnd;
                            })
                            .reduce((sum, i) => sum + (i.amount || 0), 0);
                        
                        const status = daysCovered === daysInMonthNum ? 'Complete' : 'Incomplete';
                        const achievement = proratedTarget > 0 ? (actual / proratedTarget * 100) : 0;
                        const variance = actual - proratedTarget;
                        const remainingDays = daysInMonthNum - daysCovered;
                        const neededToTarget = fullMonthTarget - actual;
                        
                        targetRows.push({
                            'Branch': branch === 'Pharmacy POS' ? 'Syokimau' : 'Katani',
                            'Month-Year': formatMonthYear(monthDate),
                            'Daily Target (KSh)': dailyTarget,
                            'Full Month Target (KSh)': fullMonthTarget,
                            'Days in Month': daysInMonthNum,
                            'Days Covered': daysCovered,
                            'Actual Sales (KSh)': actual,
                            'Status': status,
                            'Achievement %': achievement.toFixed(1) + '%',
                            'Variance (KSh)': variance,
                            'Remaining Days': remainingDays,
                            'Needed to Target (KSh)': neededToTarget
                        });
                    });
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(targetRows), "RoadToTarget");
                
                // Raw Data (optional)
                let raw = filteredData.map(i => {
                    let { parsedDate, ...rest } = i;
                    return rest;
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(raw), "RawData");
                
                const filename = `pharmacy_report_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, filename);
                hideLoader();
                showNotification('Export Successful', `Saved as ${filename}`);
            } catch (err) { hideLoader(); showNotification('Export Error', err.message, 'error'); }
        });
        
        // Helper for cashiers/categories etc.
        function getCashiersReport() {
            const cash = {}; filteredData.forEach(i => { let c = i.user || 'Unknown'; if(!cash[c]) cash[c]={trans:0,amt:0,inv:new Set()}; cash[c].trans++; cash[c].amt+=i.amount||0; if(i.invoice_no) cash[c].inv.add(i.invoice_no); });
            return Object.entries(cash).map(([n,d]) => ({ Cashier: n, Transactions: d.trans, 'Total Sales': d.amt, 'Avg Basket Value': d.inv.size ? d.amt/d.inv.size : 0 })).sort((a,b)=>b['Total Sales']-a['Total Sales']);
        }
        function getCategoriesReport() {
            const cat = {}; let total = 0; filteredData.forEach(i => { let c = i.category || 'Unknown'; let a = i.amount||0; let q = i.qty||0; if(!cat[c]) cat[c]={amt:0,qty:0}; cat[c].amt+=a; cat[c].qty+=q; total+=a; });
            return Object.entries(cat).map(([c,d]) => ({ Category: c, 'Products Sold': d.qty, 'Sales Value': d.amt, '% of Total': total ? (d.amt/total*100) : 0 })).sort((a,b)=>b['Sales Value']-a['Sales Value']);
        }
        function getCustomersReport() {
            const cust = {}; filteredData.forEach(i => { let n = i.customer_name || 'Unknown'; let a = i.amount||0; let inv = i.invoice_no; if(!cust[n]) cust[n]={amt:0,inv:new Set()}; cust[n].amt+=a; if(inv) cust[n].inv.add(inv); });
            return Object.entries(cust).map(([n,d]) => ({ Customer: n, Visits: d.inv.size, 'Total Spent': d.amt, 'Avg Spend': d.inv.size ? d.amt/d.inv.size : 0 })).sort((a,b)=>b['Total Spent']-a['Total Spent']);
        }
    </script>
</body>
</html>
